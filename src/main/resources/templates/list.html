<!DOCTYPE html>
<html lang="en"
      layout:decorate="layout"
      xmlns:layout="https://www.ultraq.net.nz/thymeleaf/layout"
      xmlns:sec="https://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    <meta content="IE=edge" http-equiv="X-UA-Compatible">
    <meta content="width=device-width, initial-scale=1.0" name="viewport">
    <title>My First Page</title>

    <!--<link href="/css/bootstrap5.min.css" rel="stylesheet">-->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">

</head>

<body>

<header th:replace="fragments/header.html :: headerfrag"></header>
<div style="width: 90%;margin-left: auto;margin-right: auto">
    <h1>Liste des patients</h1>
        <button class="btn btn-primary" data-bs-target="#exampleModal" data-bs-toggle="modal" type="submit">Ajouter</button>
    <!--<form th:action="@{'/logout'}">
        <button type="submit">Deconnection</button>
    </form>-->
    <div style="color: #0F0" th:if="${param.success}">Opération effectuée avec succès</div>
    <div style="color: #F00" th:if="${param.error}" th:text="${param.error}"></div>

    <table class="table table-striped table-hover" th:fragment="content1">
        <thead style="background-color: #c7621e; color: whitesmoke">
        <tr>
            <th scope="col" style="width: 45px">#</th>
            <th scope="col">Nom</th>
            <th scope="col">Prenom</th>
            <th scope="col">Email</th>
            <th scope="col">Telephone</th>
            <th scope="col">Ville</th>
            <th scope="col" style="width: 220px">Action</th>
        </tr>
        </thead>
        <tbody>
        <tr th:each="patient : ${lp} ">
            <td class="align-middle" style="width: 60px" th:text="${patient.id}"></td>
            <td class="align-middle" th:text="${patient.nom}"></td>
            <td class="align-middle" th:text="${patient.prenom}"></td>
            <td class="align-middle" th:text="${patient.email}"></td>
            <td class="align-middle" th:text="${patient.telephone}"></td>
            <td class="align-middle" th:utext="${patient.ville} ? ${patient.ville.nom}:'Pas de ville'"></td>
            <td>
                <div aria-label="Toolbar with button groups" class="btn-toolbar" role="toolbar">
                        <button id="rdv" class="btn btn-outline-success" type="submit">Nouveau Rdv</button>
                        <button id="edit" class="btn btn-outline-primary" type="submit" th:onclick="|editPatient(${patient.id})|">Modifier</button>
                        <button class="btn btn-outline-danger" type="submit">Supprimer</button>
                </div>
            </td>
        </tr>
        </tbody>

    </table>
</div>

    <footer th:replace="fragments/footer.html :: footerfrag"></footer>
    <!-- Modal-->
    <div aria-hidden="true" aria-labelledby="exampleModalLabel" class="modal fade" id="exampleModal" tabindex="-1">

        <div class="modal-dialog">
            <form  name="villeForm" method="POST" action="/patient/add">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="exampleModalLabel">Ajouter un patient</h5>
                        <button aria-label="Close" class="btn-close" data-bs-dismiss="modal" type="button"></button>
                    </div>
                    <div class="progress">
                        <div id="pb" class="progress-bar" role="progressbar" style="width: 25%;" aria-valuenow="25" aria-valuemin="0" aria-valuemax="100">1/5</div>
                    </div>
                    <div class="modal-body">
                        <div th:replace="add_edit.html :: editpatient"></div>
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-secondary" type="submit">Valider</button>
                        <button class="btn btn-danger float-end" type="reset">Annuler</button>
                    </div>
                </div>
            </form>
        </div>
    </div>

<script>
    const rdv = document.getElementById("rdv");
    const edit = document.getElementById("edit");

    rdv.addEventListener('click', function() {editRdv(14)},false);

    function doAjax() {

        console.log("doAjax");

        let xhr = new XMLHttpRequest();

        xhr.onreadystatechange = function() {
            // instructions of anonymous function
            if (xhr.readyState == 4 && xhr.status == 200) {
                console.log(xhr.responseText);
            }
        };

        let emailValue = document.getElementById('email').value;
        xhr.open("GET", "/patient/check?email="+emailValue, true);
        xhr.send();
    }

    var emailInput = document.getElementById("email");
    emailInput.onblur=doAjax;

    function newRdv( id ){
        console.log(id);
    }

    function editPatient(id){
        fetch('/patient/edit/'+ id, {
            method: 'GET',
            redirect: 'follow'
        })
        .then( function(response) {
            if (!response.ok) {
                window.location = "/patient?error=Problème";
            }else{
                window.location = "/patient/edit/"+ id;
            }
        } );
    }

    function editRdv(id){
        fetch('/rdv/add/'+id, {
            method: 'GET',
            redirect: 'follow',

        })
            .then( function(response) {
                if (!response.ok) {
                    window.location = "/patient?error=Problème";
                }else{
                    window.location = "/rdv/add/"+id;
                }
            } );
    }
</script>

</body>
</html>